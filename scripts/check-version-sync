#!/usr/bin/env sh
set -eu

cd "$(dirname "$0")/.."

VERSION_FILE="VERSION"
LOCATIONS_FILE="scripts/version-locations.yml"

error_exit() {
  printf '%s\n' "$1" >&2
  exit 1
}

if [ ! -f "$VERSION_FILE" ]; then
  error_exit "Missing $VERSION_FILE"
fi

version=$(sed -n '1p' "$VERSION_FILE" | tr -d '[:space:]')

if [ -z "$version" ]; then
  error_exit "Version file is empty"
fi

if ! printf '%s\n' "$version" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
  error_exit "Invalid version format in $VERSION_FILE (expected MAJOR.MINOR.PATCH)"
fi

if [ ! -f "$LOCATIONS_FILE" ]; then
  error_exit "Missing $LOCATIONS_FILE"
fi

target_paths=''
if ! target_paths=$(grep -E '^[[:space:]]*- path:' "$LOCATIONS_FILE" | sed -E 's/^[[:space:]]*- path:[[:space:]]*//'); then
  target_paths=''
fi
target_count=0

if [ -n "$target_paths" ]; then
  while IFS= read -r target; do
    target=$(printf '%s' "$target" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
    if [ -z "$target" ]; then
      continue
    fi
    target_count=$((target_count + 1))
    if [ ! -f "$target" ]; then
      error_exit "Registered target not found: $target"
    fi
    target_version=$(sed -n '1p' "$target" | tr -d '[:space:]')
    if [ "$target_version" != "$version" ]; then
      error_exit "Version mismatch in $target (expected $version, found $target_version)"
    fi
    printf 'Verified %s contains version %s\n' "$target" "$version"
  done <<EOF
$target_paths
EOF
fi

if [ "$target_count" -eq 0 ]; then
  printf 'Version %s has no registered targets to verify.\n' "$version"
else
  printf 'Version %s matches %s registered target(s).\n' "$version" "$target_count"
fi
